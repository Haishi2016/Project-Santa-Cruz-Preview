# Securing your AI model and data

Santa Cruz provides AI model protections [at rest](protection-at-rest.md), [during transition](protection-in-transition.md) and [in use](protection-in-use.md). It's designed to work with existing AI systems and workflows such as [Azure Machine Learning]( https://azure.microsoft.com/en-us/services/machine-learning/), [Azure Databricks]( https://azure.microsoft.com/en-us/services/databricks/), and [Azure Cognitive Services]( https://azure.microsoft.com/en-us/services/cognitive-services/). The long-term goal of Santa Cruz is to provide a unified experience across underlying systems. 

The Santa Cruz preview kit is shipped with a secured AI model locker and a Python SDK, as highlighted in the following diagram. The server provides secured key and model management capabilities. In the future the SDK will interact with device TPM and attestation service to prove device identity with the server to retrieve protected keys or models.

![Architecture](./imgs/architecture.png)


## Provision a new secured locker
A secured AI model locker relies on a number of Azure resources to operate. Please see [server topology](server-topology.md) for more details. We offer the automated scripts to provision your server instance on Azure.  

### Step 1. Provision server (TODO: change azuredeploy.json file location to the official path)

[![Deploy to Azure](https://aka.ms/deploytoazurebutton)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FJiaBaoxi%2FPublicShare%2Fmaster%2Fazuredeploy.json)

### Step 2: Update deployment using PowerShell script

#### Prerequisites

We offer a PowerShell script for server deployment. To run the script, you need:

* [Git Bash](https://git-scm.com/downloads)
* [PowerShell](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7)
* [Azure PowerShell Module](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-4.6.1)

#### Update server access

1. Clone this repository
   ```bash
   git clone https://github.com/microsoft/Project-Santa-Cruz-Preview.git
   cd Project-Santa-Cruz-Preview
   ```
2. Launch PowerShel
3. Run the deployment script:
   ```bash
   cd "Sample-Scripts-and-Notebooks/Official/Secured Locker/deployment"
   ./device_identity.ps1 -vaultName <Azure Key Vault instance name generated by provision step> -subscription <Azure subscription name or id>
   ```
   For example, the following script genernates a new Service Princiapl and grant it access to  ```scz-mm1-kv``` key vault instance under ```my-subscription``` subscription.

   ```bash
    ./device_identity.ps1 -vaultName scz-mm1-kv -subscription my-subscription
    ```
4. The script then pops up a web browser for you to log in to your Azure subscription. Login to your Azure account to continue.
5. Once the script finishes, it outputs the service principal that is granted access to the Azure Key Vault service. 

   ```bash
   Santa Cruz Secred Model Management server is provisioned at:  ...
   Service Princiapl Client ID:     3f38...
   Service Princiapl Tenant ID:     72f9...
   Service Princiapl Client Secret: bf49...
   ```
   > **NOTE**: Note down the service principal credential. You'll use it to login to the Santa Cruz server later.

### Step 3:  Add TLS certificate to Gateway

A secured AI model locker is deployed with an [Azure Application Gateway](https://docs.microsoft.com/en-us/azure/application-gateway/overview) as its entry point. By default, the Gateway is configured to serve an HTTP endpoint only. As we may need to pass decryption key to the client-side containers, you should enable HTTPS on the Application Gateway instance with a proper certificate that has the subject matching with the gatewayâ€™s FQDN.

We offer a ```config_certificate.ps1``` PowerShell script to assist you to configure the certificate. If you don't have a certificate, the script generates a self-signed certificate (for testing purposes only). You'll need ```openssl``` to generate the certificate.

>NOTE: The easiest way to get ```openssl``` on Windows 10 is to install Git Bash, which comes with ```openssl``` under folder ```c:\Program Files\Git\usr\bin```. Our script assume you've added openssl to your PATH variable.

1. Launch PowerShell as an Administrator
   > **NOTE**: we need administrative privilege for key operations while creating the self-signed certificate.
2. Run the update script:
   ```ps
   .\config_certificate.ps1 -subscription <Azure subscription name or id> -prefix <Azure Key Vault instance name generated by provision step> -resourceGroup <resource group of your deployment> -location <location of your deployment>
   ```
   >**NOTE**: Make sure ```location```, ```resourceGroup```, ```subscription``` and ```prefix``` match with your earlier settings.

   For example, the following command updates your locker deployment with a self-signed certificate.
   ```
   .\config_certificate.ps1 -subscription my-subscription -prefix scz-mm1  -resourceGroup scz-mm -location westus2
   ```

   To use your own certificate, run the script with a ```certFile``` parameter pointing to your ```.pfx``` file and ```certPassword``` parameter with your private key password. For example:

   ```ps
   .\config_certificate.ps1 -subscription my-subscription -prefix scz-mm1  -resourceGroup scz-mm  -location westus2 -certFile .\appgwcert.pfx -certPassword abc
   ```

3. When prompted (only when you use auto-generated certificate), enter a password for your certificate private key.

Once the script is complete, your Application Gateway will be configured to use HTTPS (via port 443) instead of HTTP (via port 5000).

### Step 4: Install Python SDK (TBD)
